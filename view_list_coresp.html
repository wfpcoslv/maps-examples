<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="./pure-min.css">


<!-- The order of inclusion of external JS files is important on this example //-->
<script type="text/javascript" src="beneficiary.js"></script>
<script type="text/javascript" src="input.js"></script>
<script type="text/javascript" src="js/Nutrimiles.js"></script>
<script type="text/javascript" src="js/lang.js"></script>
<script type="text/javascript" src="js/lang_es.js"></script>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/papaparse.min.js"></script>

<script type="text/javascript">
var nutrimiles = null;

$(function() {
  init();
});

var tblBoys;
var tblGirls;

function calculateRation(events) {
  var given_scp = 0;
  var allowed_scp = 0;
	for (i=0;i<events.length;i++) {
    if(events[i].patientData.weight == 0) {
      given_scp += events[i].patientData.scp_received
    } else {
      allowed_scp += 5; // User is allowed to get 5 units by visit
    }
	}
	return allowed_scp - given_scp;
}

function init() {

  nutrimiles = new Nutrimiles();
  
  tblBoys = Papa.parse('./data/lhfa_boys_z_exp.txt', {download: true});
  tblGirls = Papa.parse('./data/lhfa_boys_z_exp.txt', {download: true});

  if(nutrimiles.status()!=1) {
    // Critical error found, stop.
    window.alert(lang.default_alert);
    return;
  }

	var htmlToDisplay = '';

  if(nutrimiles.userInfo.userID == 2) { // Hardcoded Store id.
    
    var allowedRations = calculateRation(nutrimiles.event)
    // Units to register
    if(allowedRations > 0) {
      htmlToDisplay += '<p>'+lang.is_allowed_to_get+allowedRations
        +lang.units_csp+'</p>';
    } else {
      htmlToDisplay += '<p>'+lang.not_allowed+'</p>';
    }
    
    document.getElementById("msg").innerHTML = htmlToDisplay;
  } else { 
  
    htmlToDisplay = '<tr>';
    // weight - all
    htmlToDisplay += '<th>'+lang.visit_date+'</th>';
    htmlToDisplay += '<th>'+lang.age_days+'</th>';
    htmlToDisplay += '<th>'+lang.weight+'</th>';
    if (BENEFICIARY_AGE > 2)
    {
      // height - > 2 years old
      htmlToDisplay += '<th>'+lang.height+'</th>';
    }
    else
    {
      // length - child <= 2
      htmlToDisplay += '<th>'+lang.lenght+'</th>';
      htmlToDisplay += '<th>'+lang.head_circum+'</th>';
    }
    if (BENEFICIARY_GROUP_ID == 1)
    {
      // mother
      htmlToDisplay += '<th>'+lang.gest_age+'</th>';
      htmlToDisplay += '<th>'+lang.intra_growth+'</th>';
    }
    htmlToDisplay += '<th>'+lang.nutritional_status+'</th>';
    htmlToDisplay += '</tr>';
    document.getElementById("historyTable").innerHTML = htmlToDisplay;

    console.log(nutrimiles.event);
    numVisits = nutrimiles.event.length;    
        
    document.getElementById("msg").innerHTML = "Patient has visited the doctor "+numVisits+" times before.<br>"
    
    table = document.getElementById("historyTable");
    
    var birth_date = new Date(Date.parse(nutrimiles.beneficiary.birthDate));
    
    for (i=0;i<numVisits;i++) {
      currentVisit = nutrimiles.event[i];
      var row = table.insertRow(1);
      var row_date = new Date(Date.parse(currentVisit.validationDate))
      var age_days = Math.floor((row_date.getTime()-birth_date.getTime())/86400000)
      
      // weight for all
      row.insertCell(0).innerText = row_date.getDate()+'/'
        +(row_date.getMonth()+1)+'/'
        +row_date.getFullYear();
      row.insertCell(1).innerText = age_days;
      row.insertCell(2).innerText = currentVisit.patientData.weight;
      
      if (BENEFICIARY_AGE > 2)
      {
        row.insertCell(3).innerText = currentVisit.patientData.height;
      }
      else
      {
        // length - child <= 2
        row.insertCell(3).innerText = currentVisit.patientData.length;
        row.insertCell(4).innerText = currentVisit.patientData.head_circumference;
      }
      if (BENEFICIARY_GROUP_ID == 1)
      {
        // mother
        row.insertCell(4).innerText = currentVisit.patientData.gestational_age;
        row.insertCell(5).innerText = currentVisit.patientData.intrauterine_growth;
      }

      //bmi = Math.floor(weight/(height*height)*10000);
      //row.insertCell(2).innerText=bmi;
    }
	
  }
}
</script>
</head>
<body>
<div id="msg">
</div>
<table class="pure-table pure-table-bordered" id="historyTable">
</table>
</body>
</html>
