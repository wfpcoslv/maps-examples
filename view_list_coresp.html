<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="./pure-min.css">

<!-- The order of inclusion of external JS files is important on this example //-->
<script type="text/javascript" src="beneficiary.js"></script>
<script type="text/javascript" src="js/Nutrimiles.js"></script>
<script type="text/javascript" src="js/lang.js"></script>
<script type="text/javascript" src="js/lang_es.js"></script>
<script type="text/javascript" src="js/jquery.min.js"></script>
<!-- Nutritional information is loaded from JS files //-->
<!-- Height for Age Girls Z Scores //-->
<script type="text/javascript" src="data/lhfa_girls_z_exp.js"></script>
<!-- Height for Age Boys Z Scores //-->
<script type="text/javascript" src="data/lhfa_boys_z_exp.js"></script>
<!-- Weight for Age Girls Z Scores //-->
<script type="text/javascript" src="data/wfa_girls_z_exp.js"></script>
<!-- Weight for Age Boys Z Scores //-->
<script type="text/javascript" src="data/wfa_boys_z_exp.js"></script>
<!-- Weight for Height Girls Z Scores //-->
<script type="text/javascript" src="data/wfh_girls_z_exp.js"></script>
<!-- Weight for Height Boys Z Scores //-->
<script type="text/javascript" src="data/wfh_boys_z_exp.js"></script>
<!-- Weight for Lenght Girls Z Scores //-->
<script type="text/javascript" src="data/wfl_girls_z_exp.js"></script>
<!-- Weight for Lenght Boys Z Scores //-->
<script type="text/javascript" src="data/wfl_boys_z_exp.js"></script>

<script type="text/javascript">
var nutrimiles = null;

$(function() {
  init();
});

function init() {

	if(nutrimiles == null)
	{
		nutrimiles = new Nutrimiles()
	}
	
  if(nutrimiles.status()!=1) {
    // Critical error found, stop.
    window.alert(lang.default_alert);
    return;
  }
  
	var htmlToDisplay = '';

  if(nutrimiles.getUserInformations().id == 2) { // Hardcoded Store id.
    
    var allowedRations = calculateRation(nutrimiles.getTransactions())
    // Units to register
    if(allowedRations > 0) {
      htmlToDisplay += '<p>'+lang.is_allowed_to_get+allowedRations
        +lang.units_csp+'</p>';
    } else {
      htmlToDisplay += '<p>'+lang.not_allowed+'</p>';
    }
    
    document.getElementById("msg").innerHTML = htmlToDisplay;
  } else { 
  
    htmlToDisplay = '<tr>';
    // weight - all
    htmlToDisplay += '<th>'+lang.visit_date+'</th>';
    htmlToDisplay += '<th>'+lang.age_days+'</th>';
    htmlToDisplay += '<th>'+lang.weight+'</th>';
    if (age_days(nutrimiles.getBeneficiaryInformations().birth_date) > 720)
    {
      // height - > 2 years old
      htmlToDisplay += '<th>'+lang.height+'</th>';
    }
    else
    {
      // length - child <= 2
      htmlToDisplay += '<th>'+lang.lenght+'</th>';
      htmlToDisplay += '<th>'+lang.circum+'</th>';
    }
    if (nutrimiles.getBeneficiaryInformations().group_id == 1)
    {
      // mother
      htmlToDisplay += '<th>'+lang.gest_age+'</th>';
      htmlToDisplay += '<th>'+lang.intra_growth+'</th>';
    }
    htmlToDisplay += '<th>'+lang.nutritional_status+'</th>';
    htmlToDisplay += '</tr>';
    document.getElementById("historyTable").innerHTML = htmlToDisplay;

    console.log(nutrimiles.getTransactions());
    numVisits = nutrimiles.getTransactions().length;    
        
    document.getElementById("msg").innerHTML = "Patient has visited the doctor "+calculateVisits(nutrimiles.getTransactions())+" times before.<br>"
    
    table = document.getElementById("historyTable");
    
    var birth_date = new Date(nutrimiles.getBeneficiaryInformations.birth_date);
    
    var benef_info = nutrimiles.getBeneficiaryInformations();
    
    for (i=0;i<numVisits;i++) {
      currentVisit = nutrimiles.getTransactions()[i];
      if(currentVisit.patientData.weight != 0) {
        var row = table.insertRow(1);
        var row_date = new Date(Date.parse(currentVisit.validationDate))
        // weight for all
        row.insertCell(0).innerText = row_date.getDate()+'/'
          +(row_date.getMonth()+1)+'/'
          +row_date.getFullYear();
        row.insertCell(1).innerText = currentVisit.patientData.age;
        row.insertCell(2).innerText = currentVisit.patientData.weight;
        
        if (currentVisit.patientData.age > 720)
        {
          row.insertCell(3).innerText = currentVisit.patientData.height;
          switch(benef_info.gender) {
            case 1: // Girls
              row.insertCell(4).innerText = "T/E: "+calculate_z_deviation(
                  currentVisit.patientData.height,
                  lhfa_girls_z[currentVisit.patientData.age].SD0,
                  lhfa_girls_z[currentVisit.patientData.age].SD1
                )+ ", P/E: "+calculate_z_deviation(
                  currentVisit.patientData.weight,
                  wfa_girls_z[currentVisit.patientData.age].SD0,
                  wfa_girls_z[currentVisit.patientData.age].SD1
                )+ ", P/T: "+find_z_deviation_height(
                  wfh_girls_z,
                  currentVisit.patientData.height,
                  currentVisit.patientData.weight
                )
              break;
            case 2: // Boys
              row.insertCell(4).innerText = "T/E: "+calculate_z_deviation(
                  currentVisit.patientData.height,
                  lhfa_boys_z[currentVisit.patientData.age].SD0,
                  lhfa_boys_z[currentVisit.patientData.age].SD1
                )+ ", P/E: "+calculate_z_deviation(
                  currentVisit.patientData.weight,
                  wfa_boys_z[currentVisit.patientData.age].SD0,
                  wfa_boys_z[currentVisit.patientData.age].SD1
                )+ ", P/T: "+find_z_deviation_height(
                  wfh_boys_z,
                  currentVisit.patientData.height,
                  currentVisit.patientData.weight
                )
              break;
          }
        }
        else
        {
          // length - child <= 2
          row.insertCell(3).innerText = currentVisit.patientData.length;
          row.insertCell(4).innerText = currentVisit.patientData.head_circumference;
          // Look for the adecuate nutritional info.
          switch(benef_info.gender) {
            case 1: // Girls
              row.insertCell(5).innerText = "T/E: "+calculate_z_deviation(
                  currentVisit.patientData.length,
                  lhfa_girls_z[currentVisit.patientData.age].SD0,
                  lhfa_girls_z[currentVisit.patientData.age].SD1
                )+ ", P/E: "+calculate_z_deviation(
                  currentVisit.patientData.weight,
                  wfa_girls_z[currentVisit.patientData.age].SD0,
                  wfa_girls_z[currentVisit.patientData.age].SD1
                )+ ", P/T: "+find_z_deviation_length(
                  wfl_girls_z,
                  currentVisit.patientData.length,
                  currentVisit.patientData.weight
                )
              break;
            case 2: // Boys
              row.insertCell(5).innerText = "T/E: "+calculate_z_deviation(
                  currentVisit.patientData.length,
                  lhfa_boys_z[currentVisit.patientData.age].SD0,
                  lhfa_boys_z[currentVisit.patientData.age].SD1
                )+ ", P/E: "+calculate_z_deviation(
                  currentVisit.patientData.weight,
                  wfa_boys_z[currentVisit.patientData.age].SD0,
                  wfa_boys_z[currentVisit.patientData.age].SD1
                )+ ", P/T: "+find_z_deviation_length(
                  wfl_boys_z,
                  currentVisit.patientData.length,
                  currentVisit.patientData.weight
                )
              break;
          }
        }
        
        if (nutrimiles.getBeneficiaryInformations().group_id == 1)
        {
          // mother
          row.insertCell(4).innerText = currentVisit.patientData.gestational_age;
          row.insertCell(5).innerText = currentVisit.patientData.intrauterine_growth;

          bmi = Math.floor(
            currentVisit.patientData.weight/(
              currentVisit.patientData.height*currentVisit.patientData.height
              )*10000);
          row.insertCell(6).innerText="BMI: "+bmi;
        }

      }
    }
	
  }
}
</script>
</head>
<body>
<div id="msg">
</div>
<table class="pure-table pure-table-bordered" id="historyTable">
</table>
</body>
</html>
