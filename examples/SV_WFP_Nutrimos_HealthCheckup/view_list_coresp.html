<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="./pure-min.css">
<style type="text/css">
body {
  margin-top: 30px;
}
#msg {
  font-size: 1.2em;
}
.tooltip {
  font-size: 0.5em;
  font-color: rgb(25,25,125);
}
</style>

<!-- The order of inclusion of external JS files is important on this example //-->
<script type="text/javascript" src="beneficiary.js"></script>
<script type="text/javascript" src="js/Nutrimiles.js?rev=1"></script>
<script type="text/javascript" src="js/lang.js"></script>
<script type="text/javascript" src="js/lang_es.js"></script>
<script type="text/javascript" src="js/jquery.min.js"></script>
<!-- Nutritional information is loaded from JS files //-->
<!-- Height for Age Girls Z Scores //-->
<script type="text/javascript" src="data/lhfa_girls_z_exp.js"></script>
<!-- Height for Age Boys Z Scores //-->
<script type="text/javascript" src="data/lhfa_boys_z_exp.js"></script>
<!-- Weight for Age Girls Z Scores //-->
<script type="text/javascript" src="data/wfa_girls_z_exp.js"></script>
<!-- Weight for Age Boys Z Scores //-->
<script type="text/javascript" src="data/wfa_boys_z_exp.js"></script>
<!-- Weight for Height Girls Z Scores //-->
<script type="text/javascript" src="data/wfh_girls_z_exp.js"></script>
<!-- Weight for Height Boys Z Scores //-->
<script type="text/javascript" src="data/wfh_boys_z_exp.js"></script>
<!-- Weight for Lenght Girls Z Scores //-->
<script type="text/javascript" src="data/wfl_girls_z_exp.js"></script>
<!-- Weight for Lenght Boys Z Scores //-->
<script type="text/javascript" src="data/wfl_boys_z_exp.js"></script>

<script type="text/javascript">
var nutrimiles = null;

function calculateRation(events) {
  var given_scp = 0;
  var allowed_scp = 0;
	for (i=0;i<events.length;i++) {
    if(events[i].data.scpReceived) {
      given_scp += events[i].data.scpReceived
    } else {
      allowed_scp += 5; // User is allowed to get 5 units by visit
    }
	}
	return allowed_scp - given_scp;
}

$(function() {
  init();
});

function init() {

	if(nutrimiles == null)
	{
		nutrimiles = new Nutrimiles()
	}
	
  if(nutrimiles.status()!=1) {
    // Critical error found, stop.
    window.alert(lang.default_alert);
    return;
  }

  //window.alert("Enter init. Transactions: " + JSON.stringify(nutrimiles.getTransactions()));
  //window.alert("Enter init. Beneficiary: " + JSON.stringify(nutrimiles.getBeneficiaryInformations()));
  //window.alert("Transactions number: " + calculateVisits(nutrimiles.getTransactions()));
  //window.alert("User Informations: " + JSON.stringify(nutrimiles.getUserInformations()));
  
	var htmlToDisplay = '';


  //var subStringToSearch = "SCP99";
  //var scp99 = nutrimiles.getUserInformations().id.match(subStringToSearch);
  //if(scp99 !=null) {
  //    alert("Contains Substring");
  //}

  //document.getElementById("obj_dump").innerHTML = JSON.stringify(nutrimiles.getTransactions())+JSON.stringify(nutrimiles.getBeneficiaryInformations())+"EOD";
  
  if(nutrimiles.getUserInformations().firstname == "TIENDA") { // Hardcoded Store id.
  //if(scp99!=null) {  
    var transactions = nutrimiles.getTransactions();
    var allowedRations = calculateRation(transactions)
    // Units to register
    if(allowedRations > 0) {
      htmlToDisplay += '<div id="msg">'+lang.is_allowed_to_get+allowedRations
        +lang.units_csp+'</div>';
    } else {
      htmlToDisplay += '<div id="msg">'+lang.not_allowed+'</div>';
    }
    
    document.getElementById("msg").innerHTML = htmlToDisplay;
  } else { 
  
    htmlToDisplay = '<tr>';
    // weight - all
    htmlToDisplay += '<th>'+lang.visit_date+'</th>';
    htmlToDisplay += '<th>'+lang.age_days+'</th>';
    htmlToDisplay += '<th>'+lang.weight+'</th>';
    if (age_days(nutrimiles.getBeneficiaryInformations().birth_date) > 720)
    {
      // height - > 2 years old
      htmlToDisplay += '<th>'+lang.height+'</th>';
    }
    else
    {
      // length - child <= 2
      htmlToDisplay += '<th>'+lang.lenght+'</th>';
      htmlToDisplay += '<th>'+lang.circum+'</th>';
    }
    if (nutrimiles.getBeneficiaryInformations().group_id == 1)
    {
      // mother
      htmlToDisplay += '<th>'+lang.gest_age+'</th>';
      htmlToDisplay += '<th>'+lang.intra_growth+'</th>';
    }
    htmlToDisplay += '<th>'+lang.nutritional_status+'</th>';
    htmlToDisplay += '</tr>';
    document.getElementById("historyTable").innerHTML = htmlToDisplay;

    console.log(nutrimiles.getTransactions());
    numVisits = nutrimiles.getTransactions().length;    
        
    document.getElementById("msg").innerHTML = "El paciente ha visitado al médico "+calculateVisits(nutrimiles.getTransactions())+" veces.<br>"+
    "<span class=\"tooltip\">(Deslice para ver más indicadores)</span>"
    
    table = document.getElementById("historyTable");
    
    var birth_date = new Date(nutrimiles.getBeneficiaryInformations.birth_date);
    
    var benef_info = nutrimiles.getBeneficiaryInformations();
    
    //document.getElementById("obj_dump").innerHTML = "DATA: "+JSON.stringify(nutrimiles.getTransactions());
    
    var transactions = nutrimiles.getTransactions();
    
    for (i=0;i<numVisits;i++) {
      currentVisit = transactions[i];
      if(currentVisit.data.weight) {
        var row = table.insertRow(1);
        var row_date = new Date(Date.parse(currentVisit.date))
        // weight for all
        row.insertCell(0).innerText = row_date.getDate()+'/'
          +(row_date.getMonth()+1)+'/'
          +row_date.getFullYear();
        row.insertCell(1).innerText = currentVisit.data.age;
        row.insertCell(2).innerText = currentVisit.data.weight;
        
        if (benef_info.group_id == 2) {
          if (currentVisit.data.age > 720)
          {
            row.insertCell(3).innerText = currentVisit.data.height;
            switch(benef_info.gender) {
              case 1: // Girls
                row.insertCell(4).innerText = "T/E: "+calculate_z_deviation(
                    currentVisit.data.height,
                    lhfa_girls_z[currentVisit.data.age].SD0,
                    lhfa_girls_z[currentVisit.data.age].SD1
                  )+ ", P/E: "+calculate_z_deviation(
                    currentVisit.data.weight,
                    wfa_girls_z[currentVisit.data.age].SD0,
                    wfa_girls_z[currentVisit.data.age].SD1
                  )+ ", P/T: "+find_z_deviation_height(
                    wfh_girls_z,
                    currentVisit.data.height,
                    currentVisit.data.weight
                  )
                break;
              case 0: // Boys
                row.insertCell(4).innerText = "T/E: "+calculate_z_deviation(
                    currentVisit.data.height,
                    lhfa_boys_z[currentVisit.data.age].SD0,
                    lhfa_boys_z[currentVisit.data.age].SD1
                  )+ ", P/E: "+calculate_z_deviation(
                    currentVisit.data.weight,
                    wfa_boys_z[currentVisit.data.age].SD0,
                    wfa_boys_z[currentVisit.data.age].SD1
                  )+ ", P/T: "+find_z_deviation_height(
                    wfh_boys_z,
                    currentVisit.data.height,
                    currentVisit.data.weight
                  )
                break;
            }
          }
          else
          {
            // length - child <= 2
            row.insertCell(3).innerText = currentVisit.data.length;
            row.insertCell(4).innerText = currentVisit.data.headCircumference;
            // Look for the adecuate nutritional info.
            switch(benef_info.gender) {
              case 1: // Girls
                row.insertCell(5).innerText = "T/E: "+calculate_z_deviation(
                    currentVisit.data.length,
                    lhfa_girls_z[currentVisit.data.age].SD0,
                    lhfa_girls_z[currentVisit.data.age].SD1
                  )+ ", P/E: "+calculate_z_deviation(
                    currentVisit.data.weight,
                    wfa_girls_z[currentVisit.data.age].SD0,
                    wfa_girls_z[currentVisit.data.age].SD1
                  )+ ", P/T: "+find_z_deviation_length(
                    wfl_girls_z,
                    currentVisit.data.length,
                    currentVisit.data.weight
                  )
                break;
              case 0: // Boys
                row.insertCell(5).innerText = "T/E: "+calculate_z_deviation(
                    currentVisit.data.length,
                    lhfa_boys_z[currentVisit.data.age].SD0,
                    lhfa_boys_z[currentVisit.data.age].SD1
                  )+ ", P/E: "+calculate_z_deviation(
                    currentVisit.data.weight,
                    wfa_boys_z[currentVisit.data.age].SD0,
                    wfa_boys_z[currentVisit.data.age].SD1
                  )+ ", P/T: "+find_z_deviation_length(
                    wfl_boys_z,
                    currentVisit.data.length,
                    currentVisit.data.weight
                  )
                break;
            }
          }
        }
        
        if (nutrimiles.getBeneficiaryInformations().group_id == 1)
        {
          // mother
          row.insertCell(3).innerText = currentVisit.data.height;
          row.insertCell(4).innerText = currentVisit.data.gestationalAge;
          row.insertCell(5).innerText = currentVisit.data.intrauterineGrowth;

          bmi = Math.floor(
            currentVisit.data.weight/(
              currentVisit.data.height*currentVisit.data.height
              )*10000);
          row.insertCell(6).innerText="BMI: "+bmi;
        }

      }
    }
	
  }
}
</script>
</head>
<body>
<br />
<br />
<div id="msg">
</div>
<table class="pure-table pure-table-bordered" id="historyTable">
</table>
<div id="obj_dump">
</div>
</body>
</html>
