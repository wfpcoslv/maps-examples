<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./pure-min.css">

<script type="text/javascript" language="JavaScript">
var nutrimiles = null;

function calculateRation(events) {
  var given_scp = 0;
  var allowed_scp = 0;
	for (i=0;i<events.length;i++) {
    if(events[i].data.scpReceived) {
      given_scp += events[i].data.scpReceived
    } else {
      allowed_scp += 5; // User is allowed to get 5 units by visit
    }
	}
	return allowed_scp - given_scp;
}

function init() {

  if(nutrimiles == null)
  {
    nutrimiles = new Nutrimiles();
  }

  if(nutrimiles.status()!=1) {
    // Critical error found, stop.
    window.alert(lang.default_alert);
    return;
  }

  console.log("NMI - new event...");

/* from beneficiary.js
  var BENEFICIARY_GROUP_ID = 1;
  var BENEFICIARY_AGE = 5;
*/

  var htmlToDisplay = '';

  if(nutrimiles.getUserInformations().firstname == "TIENDA") { // Hardcoded Store id.
    // Store User Interface
    
    var allowedRations = calculateRation(nutrimiles.getTransactions())
    // Units to register
    if(allowedRations > 0) {
      htmlToDisplay += '<p>'+lang.is_allowed_to_get+allowedRations
        +lang.units_csp+'</p>';
      htmlToDisplay += '<div class="pure-control-group"><label for="scp_received">'+
        lang.scp_given+'</label><input id="scp_received" type="number" placeholder="'+
        lang.in_scp+'"></div>';
  
      htmlToDisplay += '<div class="pure-controls"><input type="button" class="pure-button pure-button-primary" value="'+lang.add_entry+'" onClick="addEntry()"></button></div>';
    } else {
      htmlToDisplay += '<p>'+lang.not_allowed+'</p>';
    }
  } else { 
      // weight - all
    htmlToDisplay += 
      '<div class="pure-control-group"><label for="weight">'+lang.weight+
      '</label><input id="weight" type="number" step="0.01"  placeholder="'+
      lang.in_weight+'"></div>';
  
    switch(nutrimiles.getBeneficiaryInformations().group_id) {
      case 1: // Mother
        // height
        htmlToDisplay += '<div class="pure-control-group"><label for="height">'+
        lang.height+'</label><input id="height" type="number" step="any" placeholder="'+
        lang.in_height+'"></div>';
        
        // Gestational age
        htmlToDisplay += 
        '<div class="pure-control-group"><label for="gestational_age">'+
        lang.gest_age+'</label><input id="gestational_age" type="number" placeholder="'+lang.in_gest_age+
        '"></div>';
        
        // Intrauterine growth
        htmlToDisplay += '<div class="pure-control-group"><label for="intrauterine_growth">'+
        lang.intra_growth+'</label><input id="intrauterine_growth" type="number" step="any" placeholder="'+
        lang.in_intra_growth+'"></div>';
        break;
      case 2:
        // Child under 5
        if (age_days(nutrimiles.getBeneficiaryInformations().birth_date) > 720)
        {
          // Over 2
          // Only Height
          htmlToDisplay += '<div class="pure-control-group"><label for="height">'+
          lang.height+'</label><input id="height" type="number" step="any" placeholder="'+
          lang.in_height+'"></div>';
        } else {
          // child <= 2
          // Lenght
          htmlToDisplay += '<div class="pure-control-group"><label for="length">'+
          lang.lenght+'</label><input id="length" type="number" step="any" placeholder="'+
          lang.in_lenght+'"></div>';
          // Circumference
          htmlToDisplay += '<div class="pure-control-group"><label for="head_circumference">'+
          lang.circum+'</label><input id="head_circumference" type="number" step="any" placeholder="'+
          lang.in_circum+'"></div>';
        }
        break;
    }
  
  htmlToDisplay += '<div class="pure-controls"><input type="button" class="pure-button pure-button-primary" value="'+lang.add_entry+'" onClick="addEntry()"></button></div>';
  }
  document.getElementById("questions").innerHTML = htmlToDisplay;
}

function addEntry() {
  var patientData = null;
  
  if(nutrimiles.getUserInformations().firstname == "TIENDA") { // Hardcoded Store id.
    patientData = {
      "scpReceived": document.getElementById("scp_received").value
      };
  } else {
    patientData = {
      "weight": document.getElementById("weight").value,
      "age": age_days(nutrimiles.getBeneficiaryInformations().birth_date)
      };
    switch(nutrimiles.getBeneficiaryInformations().group_id) {
      case 1: // Mother
        patientData.height = document.getElementById("height").value;
        patientData.gestationalAge = document.getElementById("gestational_age").value;
        patientData.intrauterineGrowth = document.getElementById("intrauterine_growth").value;
        break;
      case 2:
        // Child under 5
        if (age_days(nutrimiles.getBeneficiaryInformations().birth_date) > 720)
        {
          patientData.height = document.getElementById("height").value;
        } else {
          patientData.length = document.getElementById("length").value;
          patientData.headCircumference = document.getElementById("head_circumference").value;
        }
        break;
    }
  }

  newEvent = nutrimiles.prepareEvent(patientData);

  //window.alert(JSON.stringify(newEvent));

  // we add the event to the list, to help java code to recreate input.js
  if(newEvent) {
    nutrimiles.createTransaction(newEvent);
  } else {
    window.alert(lang.default_alert);
  }
}
</script>
</head>

<script language="JavaScript" src="beneficiary.js"></script>
<script language="JavaScript" src="js/Nutrimiles.js"></script>
<script language="JavaScript" src="js/lang.js"></script>
<script language="JavaScript" src="js/lang_es.js"></script>

<body onLoad="init()">
    <form class="pure-form pure-form-aligned">
          <fieldset id="questions">
          </fieldset>
      </form>
</body>
</html>
