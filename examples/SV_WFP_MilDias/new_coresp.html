<!--
Copyright (C) 2017 World Food Programme - All Rights Reserved.

This file is part of "MAPS Co-responsibilities Examples".

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

Implementation examples originally written by Mario Gómez.
For more info about this examples contact at <mario.gomez@wfp.org>

//-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./pure-min.css">
    <link rel="stylesheet" href="./js/jquery.mobile-1.4.5/jquery.mobile.inline-png-1.4.5.min.css" />
    <link rel="stylesheet" href="./js/jquery.mobile-1.4.5/jquery.mobile.theme-1.4.5.min.css" />
    <link rel="stylesheet" href="./js/jquery.mobile-1.4.5/jquery.mobile.icons-1.4.5.min.css" />
    <link rel="stylesheet" href="./js/jquery.mobile.datepicker/jquery.mobile.datepicker.css" />
    <link rel="stylesheet" href="./js/jquery.mobile.datepicker/jquery.mobile.datepicker.theme.css" />
    <style type="text/css">
.ui-page { margin-top: 60px; }
#msg {
  font-size: 1.2em;
}
.tooltip {
  font-size: 0.5em;
  font-color: rgb(25,25,125);
}
#obj_dump {
  word-wrap: break-word;
}
    </style>
    <!-- Para pruebas incluír siempre el archivo test_data.js //-->
    <script type="text/javascript" src="test_data.js?rev=1"></script>

    <!-- Preservar el orden de inclusión de los
         siguientes archivos de plataforma. //-->
    <script language="JavaScript" src="js/Nutrimiles.js"></script>
    <script language="JavaScript" src="js/lang.js"></script>
    <script language="JavaScript" src="js/lang_es.js"></script>

    <!-- Incluír los archivos de soporte de Javascript //-->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile.datepicker/external/jquery-ui/datepicker.js"></script>
    <script type="text/javascript" src="js/jquery.mobile.datepicker/jquery.mobile.datepicker.js"></script>


<script type="text/javascript" language="JavaScript">
var nutrimiles = null;

$(function() {
  init();
});

var seq = 0;

function find_age_pregnancy(preg_age) {
  return "2017-29-01";
}

function init() {

  if(nutrimiles == null)
  {
    nutrimiles = new Nutrimiles();
  }

  if(nutrimiles.status()!=1) {
    // Critical error found, stop.
    window.alert(lang.default_alert);
    return;
  }

  console.log("NMI - new event...");
  
  //$(".date-input-inline").datepicker();
  //$(".date-input").datepicker.altFormat('option', 'altFormat', 'yy-mm-dd');

  var htmlToDisplay = '';
  var currentUser = nutrimiles.getUserInformations();
  var transactions = nutrimiles.getTransactions();
  var beneficiary = nutrimiles.getBeneficiaryInformations();
  var age_in_days = age_days(beneficiary.birth_date);

  if( beneficiary.group = 1 ) { // Mujeres
    var age_pregnancy = age_days(beneficiary.fur);

    if(age_pregnancy < 54) {
      $('#pregDate').show();
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#anemia_grp').show();
      //$('#antitetanica_grp').show();
      $('#influenza_grp').show();
      //$('#ggh_grp').show();
      $('#folico_grp').show();
      $('#hierro_grp').show();
      $('#vita_grp').show();
      $('#calcio_grp').show();
      seq = 1;
    }
    if(
        (age_pregnancy >= 54) &&
        (age_pregnancy <  108)
      ) {
      $('#peso_grp').show();
      //$('#talla_grp').show();
      $('#anemia_grp').show();
      $('#antitetanica_grp').show();
      //$('#influenza_grp').show();
      //$('#ggh_grp').show();
      $('#folico_grp').show();
      $('#hierro_grp').show();
      $('#vita_grp').show();
      $('#calcio_grp').show();
      seq = 2;
    }
    if(
        (age_pregnancy >= 108) &&
        (age_pregnancy <  162)
      ) {
      $('#peso_grp').show();
      //$('#talla_grp').show();
      $('#anemia_grp').show();
      //$('#antitetanica_grp').show();
      //$('#influenza_grp').show();
      //$('#ggh_grp').show();
      $('#folico_grp').show();
      $('#hierro_grp').show();
      $('#vita_grp').show();
      $('#calcio_grp').show();
      seq = 3;
    }
    if(
        (age_pregnancy >= 162) &&
        (age_pregnancy <  216)
      ) {
      $('#peso_grp').show();
      //$('#talla_grp').show();
      $('#anemia_grp').show();
      //$('#antitetanica_grp').show();
      //$('#influenza_grp').show();
      $('#ggh_grp').show();
      $('#folico_grp').show();
      $('#hierro_grp').show();
      $('#vita_grp').show();
      $('#calcio_grp').show();
      seq = 4;
    }
    if(
        (age_pregnancy >= 216) &&
        (age_pregnancy <  270)
      ) {
      $('#peso_grp').show();
      //$('#talla_grp').show();
      $('#anemia_grp').show();
      //$('#antitetanica_grp').show();
      //$('#influenza_grp').show();
      //$('#ggh_grp').show();
      $('#folico_grp').show();
      $('#hierro_grp').show();
      $('#vita_grp').show();
      $('#calcio_grp').show();
      seq = 5;
    }
  }

  if( beneficiary.group = 3 ) { // Niños
    if(age_in_days < 30) { // Hasta mes 1
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').show();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').hide();
      $('#antipar_grp').hide();
      seq = 6;
    }
    if(
        (age_in_days >= 30) &&
        (age_in_days <  60)
      ) { // Hasta mes 2
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').hide();
      $('#antipar_grp').hide();
      seq = 7;
    }
    if(
        (age_in_days >= 60) &&
        (age_in_days <  150)
      ) { // Hasta mes 5
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').hide();
      $('#antipar_grp').hide();
      seq = 8;
    }
    if(
        (age_in_days >= 150) &&
        (age_in_days <  210)
      ) {  // Hasta mes 7
      $('#peso_grp').hide();
      $('#talla_grp').hide();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').hide();
      $('#vita_grp').show();
      $('#vitsf_grp').show();
      $('#antipar_grp').show();
      seq = 9;
    }
    if(
        (age_in_days >= 210) &&
        (age_in_days <  270)
      ) {  // Hasta mes 9
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').show();
      $('#vitsf_grp').show();
      $('#antipar_grp').hide();
      seq = 10;
    }
    if(
        (age_in_days >= 270) &&
        (age_in_days <  330)
      ) {  // Hasta mes 11
      $('#peso_grp').hide();
      $('#talla_grp').hide();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').show();
      $('#vitsf_grp').show();
      $('#antipar_grp').hide();
      seq = 11;
    }
    if(
        (age_in_days >= 330) &&
        (age_in_days <  390)
      ) {  // Hasta mes 13
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').show();
      $('#vitsf_grp').show();
      $('#antipar_grp').show();
      seq = 12;
    }
    if(
        (age_in_days >= 390) &&
        (age_in_days <  480)
      ) {  // Hasta mes 16
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').show();
      $('#antipar_grp').hide();
      seq = 13;
    }
    if(
        (age_in_days >= 480) &&
        (age_in_days <  570)
      ) {  // Hasta mes 19
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').show();
      $('#antipar_grp').hide();
      seq = 14;
    }
    if(
        (age_in_days >= 570) &&
        (age_in_days <  660)
      ) {  // Hasta mes 22
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').show();
      $('#antipar_grp').hide();
      seq = 15;
    }
    if(
        (age_in_days >= 660) &&
        (age_in_days <  750)
      ) {  // Hasta mes 24
      $('#peso_grp').show();
      $('#talla_grp').show();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').show();
      $('#vita_grp').hide();
      $('#vitsf_grp').show();
      $('#antipar_grp').show();
      seq = 16;
    }
    if(
        (age_in_days >= 750)
      ) {  // Hasta mes 24
      $('#peso_grp').hide();
      $('#talla_grp').hide();
      $('#tiponac_grp').hide();
      $('#esquemavac_grp').hide();
      $('#vita_grp').hide();
      $('#vitsf_grp').hide();
      $('#antipar_grp').hide();
      seq = 17;
    }
  }
}

function addEntry() {
  var patientData = null;

  patientData = {
    "seq" : seq
  };

  if($('pregDate').is(":visible")) {
    patientData.pregDate = $('#pregDate').val();
  }
  if($('#peso_grp').is(":visible")) {
    patientData.peso = $('#peso').val();
  }
  if($('#talla_grp').is(":visible")) {
    patientData.talla = $('#talla').val();
  }
  
  // Indicadores especificos para los niños
  if($('#tiponac_grp').is(":visible")) {
    patientData.tiponac = $('#tiponac').val();
  }
  if($('#esquemavac_gpr').is(":visible")) {
    patientData.esquemavac = $('#esquemavac').val();
  }
  if($('#vita_gpr').is(":visible")) {
    patientData.vita = $('#vita').val();
  }
  if($('#vitsf_gpr').is(":visible")) {
    patientData.vitsf = $('#vitsf').val();
  }
  if($('#antipar_gpr').is(":visible")) {
    patientData.antipar = $('#antipar').val();
  }
  
  // Indicadores especificos para las madres.
  if($('#anemia_grp').is(":visible")) {
    patientData.anemia = $('#anemia').val();
  }
  if($('#antitetanica_grp').is(":visible")) {
    patientData.antitetanica = $('#antitetanica').val();
  }
  if($('#influenza_grp').is(":visible")) {
    patientData.influenza = $('#influenza').val();
  }
  if($('#ggh_grp').is(":visible")) {
    patientData.ggh = $('#ggh').val();
  }
  if($('#folico_grp').is(":visible")) {
    patientData.folico = $('#folico').val();
  }
  if($('#hierro_grp').is(":visible")) {
    patientData.hierro = $('#hierro').val();
  }
  if($('#calcio_grp').is(":visible")) {
    patientData.calcio = $('#calcio').val();
  }

  newEvent = nutrimiles.prepareEvent(patientData);

  if(newEvent) {
    nutrimiles.createTransaction(newEvent);
  } else {
    window.alert(lang.default_alert);
  }
}
</script>
</head>
<body onLoad="init()">
    <form class="pure-form pure-form-aligned">
          <fieldset id="questions">
            <div class="pure-control-group">
              <label for="pregDate">Cálculo de edad gestacional:</label><br />
              <select id="tipocalc">
                <option value="1">FUR</option>
                <option value="2">FPP</option>
              </select><br />
              <input id="pregDate" type="text" class="date-input-inline" data-inline="false" data-role="date" />
            </div>
            <div class="pure-control-group" id="peso_grp">
              <label for="peso">Peso:</label>
              <input id="peso" class="indicator" type="number" step="0.01" placeholder="En Kg" />
            </div>
            <div class="pure-control-group" id="talla_grp">
              <label for="talla">Talla/Longitud:</label>
              <input id="talla" class="indicator" type="number" step="0.01" placeholder="En cm" />
            </div>
            <div class="pure-control-group" id="tiponac_grp">
              <label for="tiponac">Tipo de Nacimiento:</label>
              <select id="tiponac">
                <option value="1">Intrashospitalario</option>
                <option value="2">Intradomiciliar</option>
              </select>
            </div>
            <div class="pure-control-group" id="esquemavac_grp">
              <label for="esquemavac">Esquema de vacunación según edad:</label>
              <select id="esquemavac">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="vita_grp">
              <label for="vita">Micronutritentes: Vitamina A</label>
              <select id="vita">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="vitsf_grp">
              <label for="vitsf">Micronutrientes: Sulfato Ferroso</label>
              <select id="vitsf">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="antipar_grp">
              <label for="antipar">Antiparasitarios: Mebandazole</label>
              <select id="antipar">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="anemia_grp">
              <label for="anemia">Respuesta de examen Hemoglobina</label>
              <select id="anemia">
                <option value="1">Hay Anemia</option>
                <option value="2">No hay Anemia</option>
                <option value="9">No se realizó el exámen</option>
              </select>
            </div>
            <div class="pure-control-group" id="antitetanica_grp">
              <label for="antitetanica">Vacunación Antitetánica</label>
              <select id="antitetanica">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="influenza_grp">
              <label for="influenza">Vacunación Influenza Estacional</label>
              <select id="influenza">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="ggh_grp">
              <label for="ggh">Vacunación con Gamma Globulina hiperinmune antiD</label>
              <select id="ggh">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="folico_grp">
              <label for="folico">Ácido fólico</label>
              <select id="folico">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="hierro_grp">
              <label for="hierro">Hierro</label>
              <select id="hierro">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="calcio_grp">
              <label for="calcio">Calcio</label>
              <select id="calcio">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
          </fieldset>
      </form>
</body>
</html>
