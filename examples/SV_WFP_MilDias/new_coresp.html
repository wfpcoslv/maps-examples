<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./pure-min.css">
    <link rel="stylesheet" href="./js/jquery.mobile-1.4.5/jquery.mobile.inline-png-1.4.5.min.css" />
    <link rel="stylesheet" href="./js/jquery.mobile-1.4.5/jquery.mobile.theme-1.4.5.min.css" />
    <link rel="stylesheet" href="./js/jquery.mobile-1.4.5/jquery.mobile.icons-1.4.5.min.css" />
    <link rel="stylesheet" href="./js/jquery.mobile.datepicker/jquery.mobile.datepicker.css" />
    <link rel="stylesheet" href="./js/jquery.mobile.datepicker/jquery.mobile.datepicker.theme.css" />
    <style type="text/css">
.ui-page { margin-top: 60px; }
#msg {
  font-size: 1.2em;
}
.tooltip {
  font-size: 0.5em;
  font-color: rgb(25,25,125);
}
#obj_dump {
  word-wrap: break-word;
}
    </style>
    <!-- Para pruebas incluír siempre el archivo test_data.js //-->
    <script type="text/javascript" src="test_data.js?rev=1"></script>

    <!-- Preservar el orden de inclusión de los
         siguientes archivos de plataforma. //-->
    <script language="JavaScript" src="js/Nutrimiles.js"></script>
    <script language="JavaScript" src="js/lang.js"></script>
    <script language="JavaScript" src="js/lang_es.js"></script>

    <!-- Incluír los archivos de soporte de Javascript //-->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile.datepicker/external/jquery-ui/datepicker.js"></script>
    <script type="text/javascript" src="js/jquery.mobile.datepicker/jquery.mobile.datepicker.js"></script>


<script type="text/javascript" language="JavaScript">
var nutrimiles = null;

$(function() {
  init();
});

var seq = 55;

function find_age_pregnancy(preg_age) {
  return 0;
}

var capture_sequence = {
    'mother': [
      { 'days': 54,
	'seq': 1,
	'variables': [
	  'gest',
	  'peso',
	  'talla',
	  'influenza',
	  'folico',
	  'hierro',
	  'calcio'
	]
      },
      { 'days': 108,
	'seq': 2,
	'variables': [
	  'peso',
	  'anemia',
	  'antitetanica',
	  'folico',
	  'hierro',
	  'calcio'
	]
      },
      { 'days': 162,
	'seq': 3,
	'variables': [
	  'peso',
	  'folico',
	  'hierro',
	  'calcio'
	]
      },
      { 'days': 216,
	'seq': 4,
	'variables': [
	  'peso',
	  'anemia',
	  'ggh',
	  'folico',
	  'hierro',
	  'calcio'
	]
      },
      { 'days': 270,
	'seq': 5,
	'variables': [
	  'peso',
	  'talla',
	  'folico',
	  'hierro',
	  'calcio'
	]
      }
    ],
    'child': [
      { 'days': 7,
	'seq': 6,
	'variables': [
	  'peso',
	  'talla',
	  'tiponac',
	  'enrn',
	  'lactan',
	  'esquemavac'
	]
      },
      { 'days': 60,
	'seq': 7,
	'variables': [
	  'peso',
	  'talla',
	  'lactan',
	  'esquemavac'
	]
      },
      { 'days': 120,
	'seq': 8,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac'
	]
      },
      { 'days': 180,
	'seq': 9,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac'
	]
      },
      { 'days': 240,
	'seq': 10,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac',
	  'vita',
	  'vitsf'
	]
      },
      { 'days': 300,
	'seq': 11,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac',
	  'vita'
	]
      },
      { 'days': 360,
	'seq': 12,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac',
	  'vita'
	]
      },
      { 'days': 450,
	'seq': 13,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac',
	  'vitsf',
	  'antipar'
	]
      },
      { 'days': 540,
	'seq': 14,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac'
	]
      },
      { 'days': 630,
	'seq': 15,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac',
	  'vitsf',
	  'antipar'
	]
      },
      { 'days': 720,
	'seq': 16,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac'
	]
      },
      { 'days': 1000,
	'seq': 17,
	'variables': [
	  'peso',
	  'talla',
	  'esquemavac',
	  'vitsf',
	  'antipar'
	]
      }
    ]
  };
  
function findPregnancyDate(events) {
  for(var i=(events.length-1); i>=0; i--) {
    if(events[i].data.preg_offset) {
      var offset = events[i].data.preg_offset;
      var evt_date = new Date(events[i].date);
      if(offset<1) {
	// Asumir FUR.
	evt_date.setDate(evt_date.getDate()+offset);
      } else {
	// Asumir FPP
	evt_date.setDate(evt_date.getDate()+(280-offset));
      }
      
      return evt_date.toISOString();
    }
  }
  return null;
}

function displayMotherSequence() {
  //window.alert("Mother sequence");
  var found = false;
  var idx = 0;
  for(var i=0;i < capture_sequence.mother.length; i++) {
    if(age_pregnancy < capture_sequence.mother[i].days) {
      found = true;
      idx = i;
      break;
    }
  }

  if(found) {
    for(var i=0;i<capture_sequence.mother[idx].variables.length; i++) {
      $('#'+capture_sequence.mother[idx].variables[i]+'_grp').show();
  //window.alert(capture_sequence.mother[idx].variables[i]);
    }
    seq = capture_sequence.mother[idx].seq;
  } else {
    // TODO: Do nothing (for now)
  }
}
var date_pregnancy = "";
var age_pregnancy = 0;

var method = "";

function generatePregDate() {
  var selectedDate = new Date($("#pregDate").datepicker("getDate"));
  var baseDate = new Date();
  var diffDays = Math.ceil((selectedDate.getTime()-baseDate.getTime())/86400000);
  if(diffDays<1) {
    baseDate.setDate(baseDate.getDate()+diffDays);
    method = "FUR";
  } else {
    baseDate.setDate(baseDate.getDate()-(280-diffDays));
    method = "FPP";
  }
  return ""+baseDate.getFullYear()+"-"+(baseDate.getMonth()+1)+"-"+baseDate.getDate();
}

function calcEmb() {
  date_pregnancy = generatePregDate();
  var days = age_days(date_pregnancy);
  age_pregnancy = days;
  
  var baseDate = new Date(date_pregnancy);
  var today = new Date();
  
  $('#mother_info').show();
  $('#mother_edagest').html(Math.floor(days/7)+" semanas "+(days%7)+ " días.<br /> Método: "+method);
  displayMotherSequence();
  $('#gest_grp').hide();
    //window.alert("not hiding");
  $('#calc_control').hide();
  $('#submit_control').show();
}


function init() {

  if(nutrimiles == null)
  {
    nutrimiles = new Nutrimiles();
  }

  if(nutrimiles.status()!=1) {
    // Critical error found, stop.
    //window.alert(lang.default_alert);
    return;
  }

  //console.log("NMI - new event...");

  var htmlToDisplay = '';
  var currentUser = nutrimiles.getUserInformations();
  var transactions = nutrimiles.getTransactions();
  var beneficiary = nutrimiles.getBeneficiaryInformations();
  var age_in_days = age_days(beneficiary.birth_date);
  
  // First hide all input fields:
  $('#gest_grp').hide();
  $('#peso_grp').hide();
  $('#talla_grp').hide();
  $('#tiponac_grp').hide();
  $('#esquemavac_grp').hide();
  $('#vita_grp').hide();
  $('#vitsf_grp').hide();
  $('#antipar_grp').hide();
  $('#anemia_grp').hide();
  $('#antitetanica_grp').hide();
  $('#influenza_grp').hide();
  $('#ggh_grp').hide();
  $('#enrn_grp').hide();
  $('#folico_grp').hide();
  $('#hierro_grp').hide();
  $('#calcio_grp').hide();
  $('#lactan_grp').hide();
  $('#child_info').hide();
  $('#mother_info').hide();
  $('#submit_control').hide();
  $('#calc_control').hide();
  
  if( beneficiary.group_id == 1 ) { // Mujeres
    var date_pregnancy = findPregnancyDate(transactions);
    
    if(date_pregnancy===null) {
      $('#gest_grp').show();
      $('#calc_control').show();
      $("#pregDate").datepicker({"dateFormat": "yy-mm-dd"});
    } else {
      age_pregnancy = find_age_days(date_pregnancy);
      displayMotherSequence();
      //$('#gest_grp').hide();
      //$('#calc_control').hide();
      //$('#submit_control').show();
    }
  }
  
  if( beneficiary.group_id == 3 ) { // Niños
    var found = false;
    var idx = 0;
    for(var i=0;i<capture_sequence.child.length; i++) {
      if(age_in_days < capture_sequence.child[i].days) {
	found = true;
	idx = i;
	break;
      }
      ////window.alert('ap:'+age_pregnancy+' i:'+i+' ag_d:'+capture_sequence.mother[i].days);
    }
    
    if(found) {
      for(var i=0;i<capture_sequence.child[idx].variables.length; i++) {
	$('#'+capture_sequence.child[idx].variables[i]+'_grp').show();
      }
      seq = capture_sequence.child[idx].seq;
    } else {
      // TODO: Do nothing (for now)
    }
    
    $('#child_info').show();
    $('#child_birthdate').html(beneficiary.birth_date);
    $('#child_agedays').html(age_in_days);
    $('#submit_control').show();
  }
}

function addEntry() {
  var patientData = null;

  patientData = {
    "seq" : seq
  };

  if($('#pregDate').is(":visible")) {
    patientData.pregDate = $('#pregDate').val();
  }
  if($('#peso_grp').is(":visible")) {
    patientData.peso = $('#peso').val();
  }
  if($('#talla_grp').is(":visible")) {
    patientData.talla = $('#talla').val();
  }

  // Indicadores especificos para los niños
  if($('#tiponac_grp').is(":visible")) {
    patientData.tiponac = $('#tiponac').val();
  }
  if($('#esquemavac_gpr').is(":visible")) {
    patientData.esquemavac = $('#esquemavac').val();
  }
  if($('#vita_gpr').is(":visible")) {
    patientData.vita = $('#vita').val();
  }
  if($('#vitsf_gpr').is(":visible")) {
    patientData.vitsf = $('#vitsf').val();
  }
  if($('#antipar_gpr').is(":visible")) {
    patientData.antipar = $('#antipar').val();
  }

  // Indicadores especificos para las madres.
  if($('#anemia_grp').is(":visible")) {
    patientData.anemia = $('#anemia').val();
  }
  if($('#antitetanica_grp').is(":visible")) {
    patientData.antitetanica = $('#antitetanica').val();
  }
  if($('#influenza_grp').is(":visible")) {
    patientData.influenza = $('#influenza').val();
  }
  if($('#ggh_grp').is(":visible")) {
    patientData.ggh = $('#ggh').val();
  }
  if($('#folico_grp').is(":visible")) {
    patientData.folico = $('#folico').val();
  }
  if($('#hierro_grp').is(":visible")) {
    patientData.hierro = $('#hierro').val();
  }
  if($('#calcio_grp').is(":visible")) {
    patientData.calcio = $('#calcio').val();
  }

  newEvent = nutrimiles.prepareEvent(patientData);

  if(newEvent) {
    nutrimiles.createTransaction(newEvent);
  } else {
    //window.alert(lang.default_alert);
  }
}
</script>
</head>
<body onLoad="init()" id="index">
    <form class="pure-form pure-form-aligned">
          <fieldset id="questions">
            <div class="pure-control-group" id="child_info">
		<h3>Fecha de Nacimiento: <span id="child_birthdate"></span></h3>
		<h3>Edad (días): <span id="child_agedays"></span></h3>
            </div>
            <div class="pure-control-group" id="mother_info">
		<h3>Edad gestacional: <span id="mother_edagest"></span></h3>
            </div>
            <div class="pure-control-group" id="gest_grp">
              <h3>Cálculo de edad gestacional: Fechas anteriores a la fecha actual se estima por FUR. Fechas posteriores por FPP.</h3>
              <div id="pregDate" class="date-input-inline"></div>
            </div>
            <div class="pure-control-group" id="peso_grp">
              <label for="peso">Peso:</label>
              <input id="peso" class="indicator" type="number" step="0.01" placeholder="En Kg" />
            </div>
            <div class="pure-control-group" id="talla_grp">
              <label for="talla">Talla/Longitud:</label>
              <input id="talla" class="indicator" type="number" step="0.01" placeholder="En cm" />
            </div>
            <div class="pure-control-group" id="tiponac_grp">
              <label for="tiponac">Tipo de Nacimiento:</label>
              <select id="tiponac">
                <option value="1">Intrashospitalario</option>
                <option value="2">Intradomiciliar</option>
              </select>
            </div>
            <div class="pure-control-group" id="esquemavac_grp">
              <label for="esquemavac">Esquema de vacunación según edad:</label>
              <select id="esquemavac">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="vita_grp">
              <label for="vita">Micronutritentes: Vitamina A</label>
              <select id="vita">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="vitsf_grp">
              <label for="vitsf">Micronutrientes: Sulfato Ferroso</label>
              <select id="vitsf">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="antipar_grp">
              <label for="antipar">Antiparasitarios: Mebandazole</label>
              <select id="antipar">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="anemia_grp">
              <label for="anemia">Respuesta de examen Hemoglobina</label>
              <select id="anemia">
                <option value="1">Hay Anemia</option>
                <option value="2">No hay Anemia</option>
                <option value="9">No se realizó el exámen</option>
              </select>
            </div>
            <div class="pure-control-group" id="antitetanica_grp">
              <label for="antitetanica">Vacunación Antitetánica</label>
              <select id="antitetanica">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="influenza_grp">
              <label for="influenza">Vacunación Influenza Estacional</label>
              <select id="influenza">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="ggh_grp">
              <label for="ggh">Vacunación con Gamma Globulina hiperinmune antiD</label>
              <select id="ggh">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-control-group" id="enrn_grp">
              <label for="enrn">Estado nutricional RN</label>
              <select id="enrn">
                <option value="1">Bajo peso</option>
                <option value="2">Normal</option>
                <option value="2">Arriba de lo normal</option>
              </select>
            </div>
            <div class="pure-control-group" id="folico_grp">
              <label for="folico">Ácido fólico</label>
              <select id="folico">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="hierro_grp">
              <label for="hierro">Hierro</label>
              <select id="hierro">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="calcio_grp">
              <label for="calcio">Calcio</label>
              <select id="calcio">
                <option value="1">Sí</option>
                <option value="2">No (No hay)</option>
                <option value="3">No (No lo toma)</option>
                <option value="4">No (Otro)</option>
              </select>
            </div>
            <div class="pure-control-group" id="lactan_grp">
              <label for="lactan">Lactancia Materna</label>
              <select id="lactan">
                <option value="1">Sí</option>
                <option value="2">No</option>
              </select>
            </div>
            <div class="pure-controls" id="calc_control"><input type="button" class="pure-button pure-button-primary" value="Calcular Edad Gestacional" onClick="calcEmb()"></button></div>
            <div class="pure-controls" id="submit_control"><input type="button" class="pure-button pure-button-primary" value="Registrar visita" onClick="addEntry()"></button></div>
          </fieldset>
      </form>
</body>
</html>
